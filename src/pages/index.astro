---
import { getCollection } from 'astro:content';
import i18next from '@/i18n';
import Search from '@/components/search';
import PageLayout from '@/components/layouts/PageLayout.astro';
// import Button from '@/components/button';
import slateConfig from '~@/slate.config';

const postCollection = await getCollection('post', ({ data }) => {
  return import.meta.env.DEV || data.draft !== true;
});

const tagCounts = postCollection.reduce<Record<string, number>>(
  (res, post) => {
    const postTags = post.data.tags;
    if (!postTags || !postTags.length) return res;
    postTags.forEach((tag) => {
      if (tag.trim() === '') return;

      if (res[tag]) {
        res[tag]++;
      } else {
        res[tag] = 1;
      }
    });
    return res;
  },
  {
    [i18next.t('common.all')]: postCollection.length,
  },
);

const tags = Object.keys(tagCounts).map((tag) => ({
  name: tag,
  count: tagCounts[tag],
}));

const now = new Date();
const currentYear = now.getFullYear();
const currentMonth = now.getMonth();

const posts = [...postCollection]
  .sort((a, b) => b.data.pubDate!.getTime() - a.data.pubDate!.getTime())
  .map((post) => {
    const pubDate = post.data.pubDate!;
    const isCurrentMonth = pubDate.getFullYear() === currentYear && 
                          pubDate.getMonth() === currentMonth;
    return {
      id: post.id,
      slug: post.slug,
      url: `/blog/${post.slug}`,
      data: post.data,
      isCurrentMonth,
    };
  });
---

<PageLayout>
  <section class="relative mb-16">
    <h3 class="text-[40px] font-semibold leading-tight text-slate12">
      Code4Hope
    </h3>
    <p class="text-xl text-slate10">{slateConfig.description}</p>
    <Search
      client:only="react"
      className="absolute right-0 top-1/2 -translate-y-1/2"
    />
  </section>

  <section class="mb-16">
    <div class="text-base text-slate12">
      {
        posts.map((item) => {
          const isRecap = item.data.title.toLowerCase().includes('recap') && 
                         !item.data.title.includes('Code4Hope x Divergent Teams 2025 Recap');
          return (
            <a class="flex cursor-pointer flex-col justify-between rounded-lg py-2.5 transition-all active:scale-[0.995] active:bg-slate4 sm:flex-row sm:items-center sm:px-2 sm:hover:bg-slate3" href={item.url} title={item.data.title}>
              <span class="shrink-0 flex items-center gap-2">
                {isRecap && (
                  <span class="glowing-heart" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" />
                    </svg>
                  </span>
                )}
                {item.data.title}
                {item.isCurrentMonth && (
                  <span class="new-badge">NEW</span>
                )}
              </span>
              <span class="mx-8 hidden h-px w-full grow border-t border-dashed border-slate6 sm:flex" />
              <span class="shrink-0 text-slate8">
                {item.data.pubDate?.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                })}
              </span>
            </a>
          );
        })
      }
    </div>
    <!-- <Button className='m-auto mt-6' block> More </Button> -->
  </section>

  <!-- S 标签 -->
  <section class="mb-16">
    <ul class="flex flex-wrap gap-2 text-base text-slate10">
      {
        tags.map(({ name, count }) => (
          <li class="block cursor-pointer rounded-full bg-slate3 px-4 py-2 text-slate10 transition-all hover:bg-slate4 hover:text-slate11">
            {name}
            <sup class="text-[10px] text-slate8">{count}</sup>
          </li>
        ))
      }
    </ul>
  </section>
  <!-- E 标签 -->
</PageLayout>

<style>
  .glowing-heart {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #c084fc;
    animation: glow 2s ease-in-out infinite alternate;
    filter: drop-shadow(0 0 4px rgba(192, 132, 252, 0.6));
  }

  .glowing-heart svg {
    width: 1rem;
    height: 1rem;
  }

  @keyframes glow {
    from {
      filter: drop-shadow(0 0 4px rgba(192, 132, 252, 0.6)) drop-shadow(0 0 8px rgba(192, 132, 252, 0.4));
      opacity: 0.9;
    }
    to {
      filter: drop-shadow(0 0 8px rgba(192, 132, 252, 0.8)) drop-shadow(0 0 12px rgba(192, 132, 252, 0.6)) drop-shadow(0 0 16px rgba(192, 132, 252, 0.4));
      opacity: 1;
    }
  }

  .new-badge {
    display: inline-block;
    color: white;
    background-color: #f7495d;
    font-weight: 600;
    font-size: 0.875rem;
    letter-spacing: 0.025em;
    margin-left: 0.5rem;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
  }
</style>
